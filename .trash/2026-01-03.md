<%*
/**
 * DAILY TEMPLATE (Master-template style: single <%* %> block)
 * - 3 presets: school/work/rest
 * - Auto-create linked notes:
 *   - Journal (template if exists, else fallback)
 *   - Flashcards (plain)
 *   - Feynman (template if exists, else fallback)
 *
 * NOTE: Adjust TEMPLATE_FOLDER path if your templater folder differs.
 */

const ROOT = "CMDS";

// --- IMPORTANT: match your actual folder names exactly (Linux is case-sensitive) ---
const DAILY_FOLDER = ROOT + "/100. Inbox/102. âœ… Daily_Note";

const JOURNAL_FOLDER = ROOT + "/200. CMDS/220. Merge/221. Journaling - Daily";
const FLASH_FOLDER   = ROOT + "/200. CMDS/220. Merge/222. FlashCard - Daily";
const FEYN_FOLDER    = ROOT + "/200. CMDS/220. Merge/223. Feynman - Daily";

// Your template names (file title without .md). If mismatch, fallback note will be created.
const TEMPLATE_JOURNAL_NAME = "Journal Template";
const TEMPLATE_FEYNMAN_NAME = "Feynman Template";

// -------------------------------------------------------------

const today = tp.date.now("YYYY-MM-DD");
const yesterday = tp.date.now("YYYY-MM-DD", -1);
const nowDT = tp.date.now("YYYY-MM-DDTHH:mm:ss");

const dailyFileName = "D - " + today;

// preset ì„ íƒ
const dayKind = await tp.system.suggester(
  ["í•™êµ ê°€ëŠ” ë‚ (ìˆ˜ì—…)", "ì¼í•˜ëŠ” ë‚ ", "ì‰¬ëŠ” ë‚ "],
  ["school", "work", "rest"]
);

const preset =
  dayKind === "school" ? { label: "school", wake: "07:00", depart: "", note: "" } :
  dayKind === "work"   ? { label: "work", wake: "06:30", depart: "08:00 (8ì‹œ ì¶œë°œ)", note: "9ì‹œ ì¶œê·¼ ê¸°ì¤€" } :
                         { label: "rest", wake: "08:00", depart: "", note: "" };

const dayLabelKorean = (dayKind === "school") ? "í•™êµ" : (dayKind === "work") ? "ì¼" : "íœ´ì‹";

// ---------- utilities ----------
async function ensureFolder(path) {
  const parts = path.split("/").filter(Boolean);
  let cur = "";
  for (const part of parts) {
    cur = cur ? (cur + "/" + part) : part;
    if (!app.vault.getAbstractFileByPath(cur)) {
      try { await app.vault.createFolder(cur); } catch (e) {}
    }
  }
}
function exists(path) {
  return !!app.vault.getAbstractFileByPath(path);
}

// template find: exact name OR fuzzy search (contains string)
function findTemplateFile(name) {
  // 1) exact
  let f = tp.file.find_tfile(name);
  if (f) return f;

  // 2) fuzzy: search in templater template folder
  // You may need to change this if your template folder differs
  const TEMPLATE_FOLDER = ROOT + "/500. setting/501. Template/";
  const files = app.vault.getMarkdownFiles().filter(x => x.path.startsWith(TEMPLATE_FOLDER));
  const lower = String(name).toLowerCase();
  const hit = files.find(x => x.basename.toLowerCase() === lower) || files.find(x => x.basename.toLowerCase().includes(lower));
  return hit || null;
}

async function createFromTemplateOrFallback(templateName, fileName, folder, fallbackContentLines) {
  await ensureFolder(folder);
  const fullPath = folder + "/" + fileName + ".md";
  if (exists(fullPath)) return;

  const tfile = findTemplateFile(templateName);
  if (tfile) {
    try {
      await tp.file.create_new(tfile, fileName, false, folder);
      return;
    } catch (e) {
      // fall through to fallback
    }
  }
  // fallback
  await app.vault.create(fullPath, fallbackContentLines.join("\n"));
}

async function createPlain(fileName, folder, contentLines) {
  await ensureFolder(folder);
  const fullPath = folder + "/" + fileName + ".md";
  if (exists(fullPath)) return;
  await app.vault.create(fullPath, contentLines.join("\n"));
}

// ---------- Ensure daily note file is named & located (optional but convenient) ----------
await ensureFolder(DAILY_FOLDER);
try {
  if (tp.file.title !== dailyFileName) await tp.file.rename(dailyFileName);
} catch (e) {}
try {
  await tp.file.move(DAILY_FOLDER + "/" + dailyFileName);
} catch (e) {}

// ---------- Linked notes naming ----------
const journalName = "JRN - " + today;
const flashName   = "FC - " + today;
const feynName    = "FYN - " + today;

const LINK_J  = "[[" + journalName + "]]";
const LINK_FC = "[[" + flashName + "]]";
const LINK_FY = "[[" + feynName + "]]";

// ---------- Auto-create linked notes ----------
await createFromTemplateOrFallback(
  TEMPLATE_JOURNAL_NAME,
  journalName,
  JOURNAL_FOLDER,
  [
    "---",
    "type: journal",
    "title: " + journalName,
    "created: " + today,
    "updated: \"" + nowDT + "\"",
    "author: [[ê¹€ì„ ìŒ]]",
    "group: General",
    "status: [[ðŸšœIn Progress]]",
    "tags:",
    "  - journaling",
    "  - daily",
    "aliases: []",
    "---",
    "",
    "# " + journalName,
    "",
    "## 1) Grounding",
    "- Sleep (0~10):",
    "- Energy (0~10):",
    "- Mood (0~10):",
    "",
    "## 2) Facts (3 bullets)",
    "- ",
    "- ",
    "- ",
    "",
    "## 3) Engineering reflection",
    "- Problem:",
    "- Hypothesis:",
    "- Test:",
    "- Result:",
    "- Next iteration:",
    "",
    "## 4) Philosophy reflection",
    "- Key concept 1 + definition:",
    "- Hidden assumption:",
    "- Counterargument:",
    "- My conclusion:",
    "",
    "## 5) Closure",
    "- Tomorrow-me sentence:",
    ""
  ]
);

await createPlain(
  flashName,
  FLASH_FOLDER,
  [
    "---",
    "type: flashcards",
    "title: " + flashName,
    "created: " + today,
    "updated: \"" + nowDT + "\"",
    "author: [[ê¹€ì„ ìŒ]]",
    "group: General",
    "status: [[ðŸšœIn Progress]]",
    "tags:",
    "  - flashcards",
    "  - daily",
    "aliases: []",
    "---",
    "",
    "# " + flashName,
    "",
    "## Cards",
    "- Q:: A",
    ""
  ]
);

await createFromTemplateOrFallback(
  TEMPLATE_FEYNMAN_NAME,
  feynName,
  FEYN_FOLDER,
  [
    "---",
    "type: merge",
    "title: " + feynName,
    "created: " + today,
    "updated: \"" + nowDT + "\"",
    "author: [[ê¹€ì„ ìŒ]]",
    "group: General",
    "status: [[ðŸŒ¿Sapling]]",
    "tags:",
    "  - merge",
    "  - feynman",
    "  - daily",
    "aliases: []",
    "---",
    "",
    "# " + feynName,
    "",
    "## Explain (12ì‚´ì—ê²Œ)",
    "- ",
    "",
    "## Gaps",
    "- ",
    "",
    "## Teach-back",
    "- 3ë¬¸ìž¥:",
    "- 1ë¬¸ìž¥:",
    ""
  ]
);

// ---------- Checklist per preset ----------
let checklist = [];
if (dayKind === "school") {
  checklist = [
    "## Morning Routine (í•™êµ)",
    "- [ ] ë…ì„œ 40ë¶„ (ê¸°ìƒ ì§í›„)",
    "- [ ] ê³„íší‘œ 20ë¶„ (ì²´í¬ë¦¬ìŠ¤íŠ¸)",
    "  - [ ] ì˜¤ëŠ˜ ì•„ì¹¨ ì±… ì½ì€ ê²ƒ ê¸°ë¡(ì±…/íŽ˜ì´ì§€/í•œ ì¤„)",
    "  - [ ] ê³„íší‘œ ì“°ê¸° ì™„ë£Œ",
    "  - [ ] ì˜¤ëŠ˜ ìˆ˜ì—… ëª©ë¡",
    "    - [ ] ìˆ˜ì—… 1:",
    "    - [ ] ìˆ˜ì—… 2:",
    "    - [ ] ìˆ˜ì—… 3:",
    "  - [ ] ìˆ˜ì—… ëë‚˜ê³  í•  ê²ƒ(After class)",
    "    - [ ]",
    "    - [ ]",
    "",
    "## Evening Routine (ê³µí†µ)",
    "- [ ] ìš´ë™",
    "- [ ] ëª…ìƒ + ì €ë„ë§ â†’ " + LINK_J,
    "- [ ] í”Œëž˜ì‹œ ì¹´ë“œ(í•˜ë£¨ ì •ë¦¬) â†’ " + LINK_FC,
    "- [ ] íŒŒì¸ë§Œ ë…¸íŠ¸(ì˜¤ëŠ˜ ê³µë¶€ ì„¤ëª…) â†’ " + LINK_FY
  ];
} else if (dayKind === "work") {
  checklist = [
    "## Morning Routine (ì¼)",
    "- [ ] ì”»ê¸°",
    "- [ ] ì»¤í”¼ ë§ˆì‹œë©´ì„œ ë…ì„œ 40ë¶„",
    "- [ ] ê³„íší‘œ 20ë¶„ (ì²´í¬ë¦¬ìŠ¤íŠ¸)",
    "  - [ ] ì˜¤ëŠ˜ ì•„ì¹¨ ì±… ì½ì€ ê²ƒ ê¸°ë¡(ì±…/íŽ˜ì´ì§€/í•œ ì¤„)",
    "  - [ ] ê³„íší‘œ ì“°ê¸° ì™„ë£Œ",
    "- [ ] 8ì‹œ ì¶œë°œ(9ì‹œ ì¶œê·¼ ê¸°ì¤€)",
    "",
    "## Commute",
    "- [ ] ì¶œê·¼ê¸¸ ì±… ì½ê¸°/ì²­ì·¨(ê°€ëŠ¥í•˜ë©´)",
    "",
    "## Workday",
    "- [ ] ì¼ í•˜ë©´ì„œ ê°€ëŠ¥í•œ ë²”ìœ„ë¡œ ì±… ì½ê¸°(ì§§ê²Œë¼ë„)",
    "",
    "## After Work",
    "- [ ] ë™ì•„ë¦¬ë°©ì—ì„œ ê³µë¶€ í•  ê²ƒ ìž‘ì„±",
    "  - [ ] ê³µë¶€ ì£¼ì œ 1:",
    "  - [ ] ê³µë¶€ ì£¼ì œ 2:",
    "",
    "## Evening Routine (ê³µí†µ)",
    "- [ ] ìš´ë™",
    "- [ ] ëª…ìƒ + ì €ë„ë§ â†’ " + LINK_J,
    "- [ ] í”Œëž˜ì‹œ ì¹´ë“œ(í•˜ë£¨ ì •ë¦¬) â†’ " + LINK_FC,
    "- [ ] íŒŒì¸ë§Œ ë…¸íŠ¸(ì˜¤ëŠ˜ ê³µë¶€ ì„¤ëª…) â†’ " + LINK_FY
  ];
} else {
  checklist = [
    "## Morning Routine (íœ´ì‹)",
    "- [ ] ë…ì„œ 40ë¶„",
    "- [ ] ê³„íší‘œ 20ë¶„",
    "",
    "## Why Rest?",
    "- [ ] ì™œ ì‰¬ëŠ”ì§€ í•œ ì¤„",
    "- ì´ìœ :",
    "",
    "## Light Study",
    "- [ ] ê°„ë‹¨í•œ ì±… ì½ê¸°",
    "- [ ] ê°ìƒ/ìš”ì•½ 5~10ì¤„ â†’ " + LINK_J,
    "",
    "## Weekly Review",
    "- [ ] í”Œëž˜ì‹œ ì¹´ë“œë¡œ ì´ë²ˆì£¼ ë³µìŠµ â†’ " + LINK_FC,
    "",
    "## Evening Routine (ê³µí†µ)",
    "- [ ] ìš´ë™",
    "- [ ] ëª…ìƒ + ì €ë„ë§ â†’ " + LINK_J,
    "- [ ] í”Œëž˜ì‹œ ì¹´ë“œ(í•˜ë£¨ ì •ë¦¬) â†’ " + LINK_FC,
    "- [ ] íŒŒì¸ë§Œ ë…¸íŠ¸(ì˜¤ëŠ˜ ê³µë¶€ ì„¤ëª…) â†’ " + LINK_FY
  ];
}

// ---------- Render daily note ----------
let out = [];
out.push("---");
out.push("type: daily");
out.push("title: " + today);
out.push("created: " + today);
out.push("updated: \"" + nowDT + "\"");
out.push("author: [[ê¹€ì„ ìŒ]]");
out.push("group: General");
out.push("status: [[ðŸšœIn Progress]]");
out.push("tags:");
out.push("  - daily");
out.push("  - day/" + preset.label);
out.push("aliases: []");
out.push("day_kind: " + preset.label);
out.push("wake_time_plan: \"" + preset.wake + "\"");
out.push("depart_time_plan: \"" + preset.depart + "\"");
out.push("journal_note: \"" + LINK_J + "\"");
out.push("flashcards_note: \"" + LINK_FC + "\"");
out.push("feynman_note: \"" + LINK_FY + "\"");
out.push("---");
out.push("");
out.push("# " + today + " â€” " + dayLabelKorean + " Day");
out.push("");
out.push("## Summary (Auto)");
out.push("```dataviewjs");
out.push("const todayStr = \"" + today + "\";");
out.push("const ydayStr  = \"" + yesterday + "\";");
out.push("const toYMD = (v) => {");
out.push("  if (!v) return null;");
out.push("  if (typeof v === 'string') return v.slice(0,10);");
out.push("  if (v && typeof v.toFormat === 'function') return v.toFormat('yyyy-MM-dd');");
out.push("  if (v instanceof Date) return dv.luxon.DateTime.fromJSDate(v).toFormat('yyyy-MM-dd');");
out.push("  if (typeof v === 'object' && v.year && v.month && v.day) {");
out.push("    return dv.luxon.DateTime.fromObject({year:v.year, month:v.month, day:v.day}).toFormat('yyyy-MM-dd');");
out.push("  }");
out.push("  return null;");
out.push("};");
out.push("const pages = dv.pages().where(p => p.file.path !== dv.current().file.path);");
out.push("const pagesToday = pages.where(p => toYMD(p.created) === todayStr);");
out.push("const pagesYday  = pages.where(p => toYMD(p.created) === ydayStr);");
out.push("const needTagging = dv.pages().where(p => Array.isArray(p.tags) && p.tags.includes('tagging/needed'));");
out.push("dv.paragraph(`- Notes created today: **${pagesToday.length}**`);");
out.push("dv.paragraph(`- Notes created yesterday: **${pagesYday.length}**`);");
out.push("dv.paragraph(`- tagging/needed remaining: **${needTagging.length}**`);");
out.push("```");
out.push("");
out.push("## Summary (Write)");
out.push("- Today in 1 line:");
out.push("- Top priority:");
out.push("- Biggest win:");
out.push("- Biggest gap:");
out.push("- Tomorrow focus:");
out.push("");
out.push("---");
out.push("");
out.push("## Linked Notes (ìžë™ ìƒì„±)");
out.push("- Journal: " + LINK_J);
out.push("- Flashcards: " + LINK_FC);
out.push("- Feynman: " + LINK_FY);
out.push("");
out.push("---");
out.push("");
out.push("## Day Setup");
out.push("- [ ] ê¸°ìƒ: " + preset.wake);
if (preset.depart) out.push("- [ ] ì¶œë°œ: " + preset.depart + " _(" + preset.note + ")_");
out.push("");
out.push(checklist.join("\n"));
out.push("");
out.push("---");
out.push("");
out.push("## TODO (Today)");
out.push("- [ ]");
out.push("");

tR += out.join("\n");
%>
