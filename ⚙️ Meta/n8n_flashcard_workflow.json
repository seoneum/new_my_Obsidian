{
  "name": "Obsidian Flashcard Automation (Local)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 8
            },
            {
              "triggerAtHour": 22
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// ë‚ ì§œ ê³„ì‚°\nconst now = new Date();\nconst hour = now.getHours();\n\n// í•œêµ­ ì‹œê°„ ê¸°ì¤€\nconst kstOffset = 9 * 60 * 60 * 1000;\nconst kstNow = new Date(now.getTime() + kstOffset);\n\nconst today = kstNow.toISOString().slice(0, 10);\nconst yesterday = new Date(kstNow.getTime() - 86400000).toISOString().slice(0, 10);\n\n// 8ì‹œë©´ ì–´ì œ ë…¸íŠ¸, 22ì‹œë©´ ì˜¤ëŠ˜ ë…¸íŠ¸\nconst targetDate = hour < 12 ? yesterday : today;\nconst sessionType = hour < 12 ? 'Morning' : 'Evening';\n\nreturn [{\n  json: {\n    targetDate,\n    sessionType,\n    today,\n    yesterday,\n    hour,\n    timestamp: now.toISOString()\n  }\n}];"
      },
      "id": "code-date",
      "name": "Calculate Dates",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        220,
        0
      ]
    },
    {
      "parameters": {
        "command": "=find /data/obsidian/CMDS -name '*.md' -mtime -1 -type f 2>/dev/null | head -10"
      },
      "id": "exec-find",
      "name": "Find Recent Files",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        440,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "const output = $input.first().json.stdout || '';\nconst files = output.trim().split('\\n').filter(f => f && !f.includes('FlashCard'));\n\nif (files.length === 0) {\n  // íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒ˜í”Œ ì»¨í…ì¸ ë¡œ í…ŒìŠ¤íŠ¸\n  return [{\n    json: {\n      files: [],\n      content: '# í…ŒìŠ¤íŠ¸\\n\\nì˜¤ëŠ˜ ê³µë¶€í•œ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë…¸íŠ¸ë¥¼ ìž‘ì„±í•´ì£¼ì„¸ìš”.',\n      hasFiles: false\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    files: files.slice(0, 5),\n    firstFile: files[0],\n    hasFiles: true\n  }\n}];"
      },
      "id": "code-filter",
      "name": "Filter Files",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        660,
        0
      ]
    },
    {
      "parameters": {
        "command": "=cat \"{{ $json.firstFile }}\" 2>/dev/null || echo 'File not found'"
      },
      "id": "exec-read",
      "name": "Read File Content",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        880,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "const content = $input.first().json.stdout || 'No content';\nconst filterData = $('Filter Files').first().json;\n\nreturn [{\n  json: {\n    content: content.slice(0, 8000), // Gemini ìž…ë ¥ ì œí•œ\n    files: filterData.files,\n    hasFiles: filterData.hasFiles\n  }\n}];"
      },
      "id": "code-prep",
      "name": "Prepare Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        0
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": \"ë‹¤ìŒ Obsidian ë…¸íŠ¸ ë‚´ìš©ì„ ë¶„ì„í•´ì„œ Spaced Repetition í”ŒëŸ¬ê·¸ì¸ìš© í”Œëž˜ì‹œì¹´ë“œë¥¼ ìƒì„±í•´ì¤˜.\\n\\n## ê·œì¹™\\n1. í˜•ì‹: ì§ˆë¬¸:: ë‹µë³€ (ì½œë¡  ë‘ ê°œ, ê³µë°± ì—†ìŒ)\\n2. ì² í•™: ê°œë… ì •ì˜, ë…¼ì¦ êµ¬ì¡°, ì² í•™ìž ì£¼ìž¥\\n3. ìˆ˜í•™: ì •ë¦¬, ê³µì‹, ì¦ëª… í•µì‹¬\\n4. ì½”ë”©: ì•Œê³ ë¦¬ì¦˜, ì‹œê°„ë³µìž¡ë„, í•µì‹¬ ë¡œì§\\n5. í•œ ì¹´ë“œ = í•œ ê°œë…\\n6. ë‹µë³€ì€ 1-2ë¬¸ìž¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ\\n7. ìµœì†Œ 5ê°œ, ìµœëŒ€ 10ê°œ\\n\\n## ë…¸íŠ¸ ë‚´ìš©\\n{{ $json.content }}\\n\\n## ì¶œë ¥ í˜•ì‹\\n#flashcards íƒœê·¸ ì—†ì´ ë°”ë¡œ Q:: A í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•´ì¤˜.\"\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.7,\n    \"maxOutputTokens\": 2048\n  }\n}",
        "options": {}
      },
      "id": "gemini-api",
      "name": "Gemini Generate",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1320,
        0
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "gemini-creds",
          "name": "Gemini API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const geminiResponse = $input.first().json;\nconst flashcards = geminiResponse.candidates?.[0]?.content?.parts?.[0]?.text || 'ìƒì„± ì‹¤íŒ¨';\nconst dateInfo = $('Calculate Dates').first().json;\nconst prepData = $('Prepare Content').first().json;\n\nconst fileName = `FC - ${dateInfo.today} (${dateInfo.sessionType}).md`;\nconst filePath = `/data/obsidian/CMDS/200. CMDS/220. Merge/222. FlashCard - Daily/${fileName}`;\n\nconst content = `---\ntype: flashcards\ntitle: \"${fileName}\"\ncreated: ${dateInfo.today}\nupdated: ${dateInfo.timestamp}\nauthor: \"[[ê¹€ì„ ìŒ]]\"\ngroup: General\nstatus: \"[[ðŸšœIn Progress]]\"\ntags:\n  - flashcards\n  - daily\n  - ${dateInfo.sessionType.toLowerCase()}-review\n  - auto-generated\naliases: []\nreview_date: ${dateInfo.targetDate}\n---\n\n# ${fileName}\n\n> [!info] ìžë™ ìƒì„±\n> - ìƒì„± ì‹œê°„: ${dateInfo.timestamp}\n> - ë¦¬ë·° ëŒ€ìƒ: ${dateInfo.targetDate}\n> - ì†ŒìŠ¤ íŒŒì¼: ${prepData.files?.length || 0}ê°œ\n\n## Cards\n\n#flashcards/daily\n\n${flashcards}\n`;\n\nreturn [{\n  json: {\n    fileName,\n    filePath,\n    content\n  }\n}];"
      },
      "id": "code-format",
      "name": "Format Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1540,
        0
      ]
    },
    {
      "parameters": {
        "command": "=echo '{{ $json.content.replace(/'/g, \"'\\''\") }}' > \"{{ $json.filePath }}\""
      },
      "id": "exec-write",
      "name": "Write FC File",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        1760,
        0
      ]
    },
    {
      "parameters": {
        "command": "=cd /data/obsidian && git add . && git commit -m 'Auto-generate: {{ $json.fileName }}' && git push origin main 2>&1 || echo 'Git sync skipped'"
      },
      "id": "exec-git",
      "name": "Git Sync",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        1980,
        0
      ]
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Calculate Dates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Dates": {
      "main": [
        [
          {
            "node": "Find Recent Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Recent Files": {
      "main": [
        [
          {
            "node": "Filter Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Files": {
      "main": [
        [
          {
            "node": "Read File Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read File Content": {
      "main": [
        [
          {
            "node": "Prepare Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Content": {
      "main": [
        [
          {
            "node": "Gemini Generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Generate": {
      "main": [
        [
          {
            "node": "Format Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Output": {
      "main": [
        [
          {
            "node": "Write FC File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write FC File": {
      "main": [
        [
          {
            "node": "Git Sync",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}